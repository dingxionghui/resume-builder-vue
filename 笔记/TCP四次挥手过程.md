# TCP连接释放过程：四次挥手详解

## 什么是TCP四次挥手？

TCP连接释放需要经过"四次挥手"(four-way handshake，四向握手)过程。这就像两个人结束电话通话时的对话：
- "我说完了，没什么要说的了"
- "好的，我知道了，但我可能还有话要说"
- "我也说完了，真的没话说了"
- "好的，那就挂电话吧"

## 为什么叫"挥手"？

"挥手"是对英文"handshake"的形象翻译，就像两个人告别时相互挥手道别一样，TCP连接在结束时也需要双方互相"挥手"告别。

## 四次挥手的具体步骤

TCP连接释放过程比较复杂，客户端与服务器端都可以主动提出连接释放请求。下面以客户端主动请求释放连接为例，解释四次挥手过程：

### 第一次挥手：客户端请求断开连接

1. 当客户端完成数据传输，想要断开连接时：
   - 客户端进入FIN-WAIT-1（终止等待1）状态
   - 发送一个特殊的报文，控制位FIN=1（FIN是Finish的缩写，表示"结束"）
   - 报文序号seq=u（u等于客户端发送的最后一个字节的序号加1）
   - 这个报文不带数据
   - 发送后客户端停止发送数据
   - 这就像你对电话那头说："我这边说完了，没什么要说的了"

### 第二次挥手：服务器确认收到断开请求

1. 服务器收到断开请求后：
   - 向客户端发送确认报文，控制位ACK=1（ACK是Acknowledgment的缩写，表示"确认"）
   - 确认号ack=u+1，表示"我收到了你的结束请求"
   - 报文序号seq=v（v是服务器发送的最后一个字节序号加1）
   - 服务器进入CLOSE-WAIT（关闭等待）状态
   - 客户端收到确认后进入FIN-WAIT-2（终止等待2）状态
   - 这就像对方回答："好的，我知道你说完了，但我可能还有话要说"

2. 此时出现了"半关闭"(half-close)状态：
   - 客户端到服务器的连接已断开（客户端不再发送数据）
   - 服务器到客户端的连接还在（服务器仍可发送数据）
   - 就像你不再说话，但还在听对方说

### 第三次挥手：服务器请求断开连接

1. 当服务器也没有数据要发送时：
   - 服务器向客户端发送断开请求报文，控制位FIN=1和ACK=1
   - 报文序号seq=w（取决于半关闭状态时是否发送过数据）
   - 确认号保持ack=u+1
   - 服务器进入LAST-ACK（最后确认）状态
   - 这就像对方说："我也说完了，真的没话说了"

### 第四次挥手：客户端确认连接断开

1. 客户端收到服务器的断开请求后：
   - 向服务器发送确认报文，控制位ACK=1
   - 确认号ack=w+1，表示"我收到了你的结束请求"
   - 序号seq=u+1
   - 客户端进入TIME-WAIT（时间等待）状态
   - 这就像你回答："好的，那就挂电话吧"

2. 服务器收到确认后，关闭连接，回到CLOSED状态。

3. 客户端等待一段时间（通常是2MSL，最大报文生存时间的两倍）后，也关闭连接，回到CLOSED状态。

## 四次挥手完成！

经过这四次挥手，客户端和服务器之间的TCP连接就正式释放了。就像电话挂断后，双方的通话彻底结束。

## 为什么需要四次挥手？

三次握手建立连接，为什么释放连接需要四次挥手呢？这是因为TCP连接是全双工的（双向的）：

1. **全双工通信**：两个方向的连接是独立的，每个方向都需要单独关闭
2. **独立的关闭操作**：一方可能已经没有数据发送了，但仍需要接收另一方发送的数据
3. **应用程序的控制**：服务器收到客户端的关闭请求后，可能还需要等待应用程序处理完剩余工作

这就像电话通话结束时，一个人说"我说完了"，但可能还需要听对方说完，所以关闭连接比建立连接多了一个步骤。

## 实际案例分析

以浏览器（客户端）和Web服务器的通信为例：

1. **第一次挥手**：浏览器发送FIN=1的报文，表示"我不再发送数据了"
   - 控制位：FIN=1, ACK=1
   - 序号：seq=16752
   - 确认号：ack=69836

2. **第二次挥手**：服务器回应ACK=1的报文，表示"我知道你不发了，但我可能还要发"
   - 控制位：ACK=1
   - 序号：seq=69836
   - 确认号：ack=16753（注意这是16752+1）

3. **第三次挥手**：服务器发送FIN=1的报文，表示"我也不再发送数据了"
   - 控制位：FIN=1, ACK=1
   - 序号：seq=69836
   - 确认号：ack=16753

4. **第四次挥手**：浏览器回应ACK=1的报文，表示"我知道了，连接可以关闭了"
   - 控制位：ACK=1
   - 序号：seq=16753
   - 确认号：ack=69837（注意这是69836+1）

至此，浏览器与Web服务器之间的TCP连接完全释放。 